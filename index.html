<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Compartida de PDFs (Descarga Local)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Carga de la librería PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
    
    <!-- Carga de las librerías de Firebase (Módulos) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Exponer las funciones y objetos necesarios globalmente
        window.firebaseImports = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot, addDoc, query, serverTimestamp, setLogLevel };
    </script>
    
    <style>
        /* Fuente Inter de Tailwind */
        .inter-font { font-family: 'Inter', sans-serif; }
        /* Ajuste para el canvas del PDF */
        #pdf-canvas {
            max-width: 100%;
            height: auto;
            margin: 0 auto;
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // =========================================================================
        // NOTA IMPORTANTE PARA EJECUCIÓN LOCAL:
        // Las variables globales del entorno de Canvas deben ser definidas aquí.
        // Si desea que se conecte a SU proyecto de Firebase, reemplace los valores
        // MOCKED_... con las claves de SU proyecto.
        // =========================================================================
        const __app_id = 'local-pdf-library-app';
        const __initial_auth_token = null;
        const __firebase_config = JSON.stringify({
            apiKey: "MOCKED_API_KEY", 
            authDomain: "MOCKED_AUTH_DOMAIN", 
            projectId: "MOCKED_PROJECT_ID", 
            storageBucket: "MOCKED_STORAGE_BUCKET", 
            messagingSenderId: "MOCKED_MESSAGE_SENDER_ID", 
            appId: "MOCKED_APP_ID"
        }); 

        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged, getFirestore, collection, onSnapshot, addDoc, 
            query, serverTimestamp, setLogLevel 
        } = window.firebaseImports || {};

        // Configuración de la librería pdf.js
        const pdfjsLib = window['pdfjs-dist/build/pdf'];

        // FIX CRÍTICO: Se desestructura los hooks de React (useState, useEffect, etc.)
        // de la variable global 'React' en el ámbito del script de Babel. 
        // Esto asegura que estén definidos antes de ser llamados en el componente App.
        const { useState, useEffect, useCallback, useRef } = React;
        
        const App = () => {
            
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loadingState, setLoadingState] = useState('Inicializando conexión...');
            const [isInitialized, setIsInitialized] = useState(false);
            const [pdfDocuments, setPdfDocuments] = useState([]);
            
            // Estado para agregar nuevo documento por URL
            const [newTitle, setNewTitle] = useState('');
            const [newUrl, setNewUrl] = useState('');
            const [addStatus, setAddStatus] = useState('');

            // Estado del visor de PDF
            const [pdfDocInstance, setPdfDocInstance] = useState(null);
            const [pageNum, setPageNum] = useState(1);
            const [numPages, setNumPages] = useState(1);
            const [renderPending, setRenderPending] = useState(null);
            const [pdfFileName, setPdfFileName] = useState('Selecciona un documento');

            // Referencias DOM
            const canvasRef = useRef(null);

            // Variables de configuración global (usadas por el entorno)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

            // --- 1. Inicialización de Firebase (DB) y PDF.js ---
            useEffect(() => {
                try {
                    // Configuración del worker de PDF.js
                    if (pdfjsLib && !pdfjsLib.GlobalWorkerOptions.workerSrc) {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
                    }

                    if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey === "MOCKED_API_KEY") {
                        setLoadingState('Advertencia: Usando configuración simulada. Los datos no se guardarán en la nube. Reemplace "MOCKED_API_KEY" con su clave real.');
                        setIsInitialized(true);
                        return;
                    }
                    
                    if (setLogLevel) setLogLevel('debug');
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestore);
                    
                    const attemptSignIn = async () => {
                        try {
                            // Usamos directamente la variable global para el token de autenticación.
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
                            
                            if (token) {
                                await signInWithCustomToken(firebaseAuth, token);
                            } else {
                                // Usamos signInAnonymously si no hay token proporcionado.
                                await signInAnonymously(firebaseAuth); 
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            setLoadingState('Error de autenticación: ' + error.message);
                        }
                    };
                    attemptSignIn();

                    const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setLoadingState('Conectado. Bienvenido/a.');
                        } else {
                            setUserId(null);
                            setLoadingState('Autenticación anónima completada.');
                        }
                        setIsInitialized(true);
                    });

                    return () => unsubscribe();

                } catch (error) {
                    console.error("Error durante la inicialización de Firebase:", error);
                    setLoadingState('Error fatal al inicializar Firebase: ' + error.message);
                    setIsInitialized(true);
                }
            }, [JSON.stringify(firebaseConfig)]); // Dependencias ajustadas.

            // --- 2. Escucha de Documentos Públicos (Firestore) ---
            useEffect(() => {
                if (db && userId) {
                    // Path: /artifacts/{appId}/public/data/pdf_links (Totalmente gratis)
                    const publicCollectionPath = `/artifacts/${appId}/public/data/pdf_links`;
                    const docsRef = collection(db, publicCollectionPath);
                    const q = query(docsRef);

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const docsList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => b.uploadedAt?.seconds - a.uploadedAt?.seconds); 
                        
                        setPdfDocuments(docsList);
                        if (isInitialized) {
                            setLoadingState(`Cargados ${docsList.length} documentos públicos.`);
                        }

                    }, (error) => {
                        console.error("Error al escuchar documentos:", error);
                        setLoadingState('Error al cargar la biblioteca compartida.');
                    });

                    return () => unsubscribe(); 
                }
            }, [db, userId, appId, isInitialized]);

            // --- 3. Lógica para Agregar un Documento por URL ---
            const isValidUrl = (string) => {
                try {
                    const url = new URL(string);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch (_) {
                    return false;  
                }
            }

            const handleAddDocument = async (e) => {
                e.preventDefault();
                setAddStatus('');

                if (!newTitle.trim() || !newUrl.trim()) {
                    setAddStatus('Error: El título y la URL son obligatorios.');
                    return;
                }

                // Aunque no es un requisito estricto para la URL, es buena práctica validarlo
                if (!isValidUrl(newUrl)) { 
                    setAddStatus('Error: La URL no es válida.');
                    return;
                }
                
                if (!db) {
                    setAddStatus('Error: La base de datos no está inicializada o está en modo simulado.');
                    return;
                }

                const metadataCollectionPath = `/artifacts/${appId}/public/data/pdf_links`;
                setAddStatus('Agregando documento...');

                try {
                    const newDoc = {
                        title: newTitle.trim().substring(0, 80),
                        downloadURL: newUrl.trim(), 
                        uploadedBy: userId,
                        uploadedAt: serverTimestamp(),
                        userIdDisplay: userId,
                    };
                    
                    await addDoc(collection(db, metadataCollectionPath), newDoc);
                    setAddStatus('✅ Documento agregado con éxito!');
                    setNewTitle('');
                    setNewUrl('');
                } catch (error) {
                    console.error("Error al agregar el documento:", error);
                    setAddStatus(`❌ Error al agregar: ${error.message}`);
                }
            };

            // --- 4. Lógica de Renderizado del PDF (pdf.js) ---
            const renderPdfPage = useCallback((pdf, pageNumToRender) => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                setRenderPending(null);

                pdf.getPage(pageNumToRender).then(function(page) {
                    const viewerContainer = document.getElementById('pdf-viewer-container');
                    if (!viewerContainer) return;
                    const maxWidth = viewerContainer.offsetWidth - 32; 
                    
                    const viewport = page.getViewport({ scale: 1.0 });
                    const scale = maxWidth / viewport.width;
                    const scaledViewport = page.getViewport({ scale: scale });

                    canvas.height = scaledViewport.height;
                    canvas.width = scaledViewport.width;

                    const renderContext = {
                        canvasContext: ctx,
                        viewport: scaledViewport
                    };

                    page.render(renderContext);
                });
                setPageNum(pageNumToRender);
            }, []); // Dependencia vacía ya que las funciones y variables internas no cambian.

            useEffect(() => {
                if (pdfDocInstance) {
                    if (renderPending) {
                        const newNum = renderPending;
                        setRenderPending(null);
                        renderPdfPage(pdfDocInstance, newNum);
                    } else {
                        renderPdfPage(pdfDocInstance, pageNum);
                    }
                }
            }, [pdfDocInstance, pageNum, renderPdfPage, renderPending]);

            // Función principal para cargar un documento desde la URL
            const loadSharedPdf = (doc) => {
                setPdfFileName(doc.title);
                setLoadingState(`Cargando documento: ${doc.title} desde URL...`);
                setAddStatus(''); 
                setPdfDocInstance(null); // Limpiar visor mientras carga

                try {
                    const loadingTask = pdfjsLib.getDocument({ url: doc.downloadURL });

                    loadingTask.promise.then(function(pdf) {
                        setPdfDocInstance(pdf);
                        setNumPages(pdf.numPages);
                        setPageNum(1); 
                        setLoadingState(`Listo para leer: ${doc.title} (${pdf.numPages} páginas)`);
                    }).catch(function(reason) {
                        console.error("Error al cargar el PDF:", reason);
                        setLoadingState(`Error al cargar PDF: ${reason.message}. Asegúrate que la URL sea pública y correcta.`);
                    });
                } catch (error) {
                    console.error("Error general de carga:", error);
                    setLoadingState('Error de carga. Intenta de nuevo.');
                }
            };
            
            // Función para descargar (abre la URL directamente)
            const handleDownload = (e, doc) => {
                e.stopPropagation(); // Evita que se dispare el evento de 'Leer' del <li>
                window.open(doc.downloadURL, '_blank');
            };

            // --- 5. Handlers de Navegación ---
            const goToPrevPage = () => {
                if (pageNum > 1) {
                    const newPage = pageNum - 1;
                    setPageNum(newPage);
                    setRenderPending(newPage);
                }
            };

            const goToNextPage = () => {
                if (pdfDocInstance && pageNum < pdfDocInstance.numPages) {
                    const newPage = pageNum + 1;
                    setPageNum(newPage);
                    setRenderPending(newPage);
                }
            };

            // --- Componente de Interfaz de Carga (Fallback) ---
            if (!isInitialized) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-indigo-50 p-4">
                        <svg className="animate-spin h-10 w-10 text-indigo-700 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h1 className="text-xl font-bold text-indigo-700">Cargando la Biblioteca de PDFs...</h1>
                        <p className="mt-2 text-md text-gray-600 font-medium">{loadingState}</p>
                    </div>
                );
            }
            
            // --- Componente Principal ---
            return (
                <div className="min-h-screen bg-gray-50 p-4 inter-font">
                    <header className="text-center py-4 bg-white shadow-md rounded-xl mb-6">
                        <h1 className="text-3xl font-extrabold text-indigo-700">🔗 Biblioteca Compartida de PDFs (Método URL)</h1>
                        <p className="mt-1 text-sm text-gray-500">
                            Método 100% gratuito: Guarda y comparte solo el enlace del PDF. Usuario ID: {userId ? userId : 'Desconocido'}
                        </p>
                        <p className="mt-1 text-sm font-medium text-green-600">{loadingState}</p>
                    </header>

                    {/* Panel de Añadir Enlace y Lista */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* 1. Panel de Añadir por URL */}
                        <div className="lg:col-span-1 p-5 bg-white rounded-xl shadow-lg h-fit">
                            <h2 className="text-xl font-bold mb-4 text-indigo-600">Añadir Documento Compartido</h2>
                            <form onSubmit={handleAddDocument} className="space-y-3">
                                <input 
                                    type="text"
                                    placeholder="Título del Documento"
                                    value={newTitle}
                                    onChange={(e) => setNewTitle(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    required
                                />
                                <input 
                                    type="url"
                                    placeholder="https://servidor.com/archivo.pdf (Debe ser un enlace directo)"
                                    value={newUrl}
                                    onChange={(e) => setNewUrl(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    required
                                />
                                <button 
                                    type="submit"
                                    className="w-full py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150"
                                >
                                    Guardar Enlace y Compartir
                                </button>
                            </form>

                            {/* Resumen de estado de adición */}
                            {addStatus && (
                                <div className={`mt-4 p-3 rounded-lg text-sm font-medium ${addStatus.includes('Error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                    {addStatus}
                                </div>
                            )}
                        </div>

                        {/* 2. Lista de Documentos Compartidos */}
                        <div className="lg:col-span-2 p-5 bg-white rounded-xl shadow-lg max-h-[50vh] lg:max-h-96 overflow-y-auto">
                            <h2 className="text-xl font-bold mb-4 text-indigo-600">Documentos Públicos ({pdfDocuments.length})</h2>
                            {pdfDocuments.length === 0 ? (
                                <p className="text-gray-500 italic">Aún no hay documentos. ¡Busca el enlace de un PDF en internet y compártelo!</p>
                            ) : (
                                <ul className="space-y-3">
                                    {pdfDocuments.map((doc) => (
                                        <li 
                                            key={doc.id} 
                                            className="p-3 bg-gray-100 rounded-lg transition duration-150 border-l-4 border-indigo-500 shadow-sm flex justify-between items-center"
                                        >
                                            <div className="cursor-pointer flex-1" onClick={() => loadSharedPdf(doc)}>
                                                <p className="font-semibold text-gray-800 truncate">{doc.title}</p>
                                                <p className="text-xs text-gray-500">Agregado por: {doc.userIdDisplay.substring(0, 8)}...</p>
                                            </div>
                                            <div className="flex space-x-2 ml-4">
                                                <button 
                                                    onClick={() => loadSharedPdf(doc)}
                                                    className="px-3 py-1 bg-indigo-500 text-white text-xs font-semibold rounded-full hover:bg-indigo-600 transition duration-150 shadow-md"
                                                    title="Ver documento"
                                                >
                                                    Leer
                                                </button>
                                                <button 
                                                    onClick={(e) => handleDownload(e, doc)}
                                                    className="px-3 py-1 bg-gray-500 text-white text-xs font-semibold rounded-full hover:bg-gray-600 transition duration-150 shadow-md"
                                                    title={`Descargar ${doc.title}`}
                                                >
                                                    Descargar
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>

                    <div id="pdf-viewer-container" className="mt-8">
                        {/* 3. Visor de PDF */}
                        <h2 className="text-2xl font-bold text-center mb-4 text-gray-700">{pdfFileName}</h2>
                        
                        {pdfDocInstance && (
                            <div className="flex justify-center items-center space-x-4 mb-4">
                                <button 
                                    onClick={goToPrevPage} 
                                    disabled={pageNum <= 1} 
                                    className="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    &larr; Anterior
                                </button>
                                <span className="text-lg font-bold text-gray-700">Página: {pageNum} / {numPages}</span>
                                <button 
                                    onClick={goToNextPage} 
                                    disabled={pageNum >= numPages} 
                                    className="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Siguiente &rarr;
                                </button>
                            </div>
                        )}

                        <div className="bg-white rounded-xl shadow-2xl p-4 flex justify-center">
                            <canvas id="pdf-canvas" ref={canvasRef} className="border border-gray-200"></canvas>
                        </div>
                        
                        {!pdfDocInstance && (
                            <div className="p-10 text-center text-gray-500 bg-white rounded-xl shadow-lg mt-4">
                                Selecciona un documento de la lista o añade uno nuevo.
                            </div>
                        )}
                    </div>
                    
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
